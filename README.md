# openmm workspace

This directory provides a compact OpenMM example workflow.  
Configuration lives in YAML, and the simulation follows the sequence energy minimisation → NVT → NPT → production. The repository contains the scripts needed to run the simulation and inspect the resulting data.

## Contents
- `01_md.py` — main MD driver. Loads parameters with PyYAML and supports selecting restrained atoms through MDAnalysis syntax.
- `config.yaml` — central configuration for inputs, outputs, simulation phases, and reporting cadence.
- `run_hrex.py` — launches Hamiltonian replica exchange (HREX) simulations using openmmtools.
- `requirements.txt` — Python dependencies; in addition to a working OpenMM installation you need `pyyaml` and `MDAnalysis`.
- `utils/monitor_basic_quantity.py` — analysis helper that plots quantities from `md_log.txt` on a nanosecond time axis, computes structural metrics (RMSD / RMSF / radius of gyration), and estimates the isobaric heat capacity (Cp) from log fluctuations.
- `utils/trjconv.py` — basic trajectory post-processing utility.
- `1AKI.pdb` — starting structure for the sample system.
- `top.pdb` / `minimized.pdb` / `traj.dcd` / `md_log.txt` — artefacts generated by the workflow (modeller topology, minimised structure, trajectory, log).
- `traj_fixed.dcd`, `pbc.py` — additional helper files.

## Setup
1. Prepare a Python environment where OpenMM is available (see `environment.yml` for a conda recipe).
2. Install the Python dependencies, including `openmmtools`/`pymbar`, for example with:
   ```bash
   conda env update -f environment.yml
   ```

## Running the Simulation
```bash
python 01_md.py --config config.yaml
```

Pipeline summary:
1. Read the input PDB, remove waters, add hydrogens, solvate, and ionise.
2. Minimise energy and write the structure to `paths.minimized`.
3. Run NVT and NPT while positional restraints are active for the configured selection.
4. Remove restraints and continue with the production phase.
5. Emit `traj.dcd` and `md_log.txt` at the configured intervals.

## Configuration (`config.yaml`)
Key sections:

- `paths`  
  - `pdb` / `topology` / `minimized` / `trajectory` / `log` / `checkpoint`: input and output file locations.
- `force_fields`: list of ForceField XML files.
- `thermodynamics`: temperature, pressure, friction coefficient, and integrator step size. The default 0.004 ps (4 fs) step is intended for hydrogen mass repartitioning (HMR).
- `system`: non-bonded cutoff, solvent padding, ionic strength, and optional `hydrogen_mass` (set to 4.0 amu by default for HMR). Remove `hydrogen_mass` and reduce the step size (e.g. 0.002 ps) if you disable HMR.
- `simulation`: step counts for each phase (`nvt_steps`, `npt_steps`, `production_steps`). Defaults correspond to 100 ps of NVT, 100 ps of NPT, and 1 µs of production.
- `reporting`: DCD, stdout, and log intervals.
- `restraints`:  
  - `force_constant` — positional restraint stiffness in kJ/mol/nm².  
  - `selection` — MDAnalysis selection string. Empty selections raise an error.

## Outputs
- `top.pdb` — solvated topology written after the modeller stage.
- `minimized.pdb` — structure after minimisation.
- `traj.dcd` — trajectory covering all simulation stages.
- `md_log.txt` — CSV log containing step, time (ps), energies, temperature, volume, density, and performance (ns/day).
- `checkpoint.chk` — latest simulation state produced by `CheckpointReporter`; path configurable via `paths.checkpoint`.

## Analysis
`utils/monitor_basic_quantity.py` plots time series from `md_log.txt`, structural metrics, and Cp estimates. Matplotlib and MDAnalysis are required.
```bash
python utils/monitor_basic_quantity.py
```
By default the script uses selections from `config.yaml`: RMSD/RMSF are computed for `protein and name CA`, and the radius of gyration for `protein`. Override these with `--selection`, `--selection-rmsf`, and `--selection-rg` as needed.  
Cp is derived from fluctuations of potential energy, kinetic energy, and volume. The command prints the aggregate Cp estimate, plots its running value, and optionally performs block-averaged error analysis when you pass `--block-size 100` (interpreted as frames per block).  
Example: analyse RMSD for the peptide backbone without hydrogens
```bash
python utils/monitor_basic_quantity.py --selection "backbone and not name H*"
```
Use the resulting figures to assess convergence and tailor the script for additional metrics.

## Notes
- `pbc.py` contains helper routines for periodic boundary operations.
- Adjust force-field files or solvent settings before transferring the workflow to another system.
- Generated trajectory and log files are ignored by Git.
- Keep the checkpoint file if you plan to restart a production run.

## Restarting from a Checkpoint

`CheckpointReporter` records restart data periodically.

- Configure the checkpoint path via `paths.checkpoint` (default `checkpoint.chk`).
- Resume production only with:
  ```bash
  python 01_md.py --config config.yaml --restart
  ```
- Override the checkpoint path on the command line with `--checkpoint custom.chk`.
- Target a specific production horizon in nanoseconds using `--until`, e.g. `--until 200` for roughly 200 ns. Restarts account for completed steps and run only the remainder.
- When running with `--restart`, both `traj.dcd` and `md_log.txt` are opened in append mode so the data remain continuous.
- The checkpoint is refreshed every `reporting.log_interval` steps.
- Do not delete `top.pdb` (from `paths.topology`); it is required for restarts because it stores the solvated topology.

## Hamiltonian Replica Exchange (HREX)
- Configure an `hrex.<name>` block in `config.yaml` to define lambda/temperature schedules, MCMC settings, reporting cadence, and the alchemical selection. The default entry illustrates a protein-residue decoupling schedule with three replicas.
- Generate the solvated topology first (e.g. by running `01_md.py` once) so that `paths.topology` exists for MDAnalysis selections.
- Launch a new HREX run:
  ```bash
  python run_hrex.py --config config.yaml --hrex default
  ```
- Use `--overwrite` to replace an existing storage file, `--no-minimize` to skip the initial minimisation, and `--equil-iterations` / `--production-iterations` to override the iteration counts from the configuration.
- Enable trajectory export by setting `hrex.reporting.position_interval` to a positive value (frames are stored every `position_interval` iterations). After the run completes, `run_hrex.py` writes one DCD per replica to `paths.hrex.trajectories` (default `data/hrex_runs/<name>/trajectories/`), using the interval and MD step size to define the time between frames.
- Resume or extend an existing run (storage file `storage.nc` inside `paths.hrex.root`) with:
  ```bash
  python run_hrex.py --config config.yaml --hrex default --resume --production-iterations 50
  ```
- HREX data are written to the NetCDF storage file (`hrex.paths.storage`) and an auxiliary checkpoint file. `run_hrex.py` additionally writes:
  - `hrex_log.csv` (per-iteration reduced potentials) in `paths.hrex.analysis`
  - `hrex_summary.txt` (full text dump of state assignments, energies, and mixing statistics drawn from `storage.nc`)
  Use these alongside the helpers in `hrex.analysis` to post-process acceptance statistics or MBAR free energies.
